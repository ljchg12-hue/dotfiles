# Claude Code Global v3.4.1
<!-- Updated: 2026-01-13 | 다층 판단 시스템 최적화 - 키워드 정제, Layer 2/3 확장 -->

> **전역 동기화**: `~/.claude/CLAUDE.md` v3.4.1 워크플로우 따름
> - Phase 2: **Question[1] 조건부** (불명확 시) + ⚡스킵 항상 제공
> - Phase 4: **다층 판단 시스템** (Layer 1~4) → AI 분석 / 일반 작업 분기
> - Phase 5: AI 분석 = Bash→AI CLI / 일반 = Task 에이전트

## 🚨 AI 분석 강제 규칙 (v3.4.1)

### 트리거 키워드 (감지 시 AI CLI 필수)
> **상세 목록**: `~/.claude/CLAUDE.md` Phase 4 참조 (핵심 25개 + Layer 2~3 다층 판단)

```
📋 기본: 분석, 리뷰, 검토, 최적화, 감사, 진단, 평가, 비교, 검증, 개선, 점검, 확인, 조사, 탐색
🎯 기획: 기획, 요구사항, 명세, 정의, 범위, 우선순위, 전략, 예측, 타당성, 리스크
🏗️ 설계: 설계, 아키텍처, 구조, 모델링, 패턴, 스키마, 프로토타입, 인터페이스
💻 구현: 리팩토링, 디버깅, 버그, 취약점, 품질, 코드리뷰, 기술부채, 복잡도
🧪 테스트: 테스트, 커버리지, 회귀, 성능, 부하, 보안, 자동화, 결함, QA
🚀 배포: 배포, 릴리스, 파이프라인, 롤백, 마이그레이션, 스테이징, 버전
🔧 운영: 모니터링, 장애, 인시던트, 복구, 유지보수, 튜닝, 스케일링, 로그
🔒 보안: 보안감사, 침투테스트, 취약점스캔, 위협모델링, 컴플라이언스
```

### 도구 선택 (Phase 5)
| 작업 유형 | 도구 | 필수 |
|----------|------|------|
| 🔴 AI 분석 (트리거 감지) | Bash → AI CLI | 필수 |
| 🟢 일반 작업 (트리거 없음) | Task 에이전트 | 기본 |

---

## MCP (Single Source)
- **~/.mcp.json**: 18개 직접등록 + Docker Gateway (요청시 로드)
- **~/.claude.json**: 설정만 (mcpServers 금지)

## NEVER KILL
Docker, Codex, Gemini, Ollama, MCP서버, 개발서버 → kill/stop 금지

## ABSOLUTE RULES (워크플로우 순서)

| Phase | # | Rule | 설명 |
|-------|---|------|------|
| **시작** | 1 | 지침 로딩 | 작업 전 자동 적용 |
| **파악** | 2 | 역질문 | **Question[1] 조건부** (불명확 시), 의도/범위/유형 파악 |
| **판단** | 3 | 추측 금지 | 직접 확인만, 가정하지 않음 |
| **분류** | 4 | 작업 유형 판단 | 트리거 키워드 → AI 분석 / 없음 → 일반 작업 |
| **선택** | 5 | 도구 선택 | 유형별 도구 결정 (AI CLI vs Task) |
| **실행** | 6 | 병렬처리 | 선택된 도구 3-7개/묶음 (유형별 분리) |
| **개발** | 7 | TDD/Worktree | 코드 작업 시 Phase별 적용 |
| **완료** | 8 | 레포팅 | 작업유형/도구/AI/MCP/Agent/통계 포함 |

## Context Management
- 묶음: 최소 3개, 최대 7개
- **예외**: AI CLI는 Cloud 4 + Ollama 4 = 8개 동시 허용
- 금지: 일반 도구 8개+ 동시, 3개 미만, 순차(독립작업시)
- 3묶음마다 진행상황 정리, 컨텍스트 초과 전 /compact

## AI CLI
| Tier | Models | 병렬 |
|------|--------|------|
| Cloud | Claude, Gemini, Codex, Copilot | 4개 |
| Code S급 | glm-4.6, qwen3-coder:480b, codellama:70b | 코드작업 필수 |
| Ollama S | mistral-large:675b, kimi-k2:1t, deepseek-v3.1:671b, cogito-2.1:671b | 4개 |
| Local 70B+ | llama3.3, deepseek-r1:70b, exaone4.0:32b 등 | 작업별 2-4개 |

**참조**: `~/.local/bin/ai-cli/AI_CLI_RULES.md`

## Agents (키워드→자동)
- 개발: python/frontend/backend-expert, ui-expert
- 설계: system/devops-architect, Plan
- 품질: quality/security-engineer, root-cause
- 리서치: deep-research, **Explore**, technical-writer
- 배치: `~/agent-system/` (31개)

## Skills
- **93개** (`~/.claude/skills/`) - 자동 감지, 필요시만 로드
- 명시적: `/skill-name` 또는 자연어

## Basic Memory
- 시작: `build_context(url="memory://", depth=2, timeframe="7d")`
- 저장: projects/troubleshooting/learnings/preferences/sessions

## Protocol (역질문 시스템)

### ⚠️ 핵심 원칙
```
요청이 불명확할 때만 Question [1]로 시작
→ 명확한 요청은 즉시 실행 가능
→ 사용자가 ⚡스킵 선택 시 즉시 실행 가능
→ "최대 7회"는 상한선, 사용자 선택이 우선
```

### 작업 흐름도
```
[사용자 요청]
    ↓
📌 Question [1] + 선택지 1~7 제시
    ↓
[사용자 선택]
    ├─ 1~4 선택 → 다음 질문 or 계획서
    ├─ 5. 💬직접입력 → 반영 후 다음 단계
    ├─ 6. 🤖Claude판단 → Claude가 진행 여부 결정
    └─ 7. ⚡바로진행 → 즉시 실행 → 보고서
         ⏹️중단 → 작업 취소
         ⏮️전단계 → 이전 질문으로
    ↓
(반복: 최대 7회 또는 100% 파악 시까지)
    ↓
📋 계획서 제시 → 사용자 승인
    ↓
⚡실행 → 📊보고서
```

### 질문 형식 (필수)
```
📌 Question [N]: [주제]
[상황 설명 + 질문]

1. [선택지1]
2. [선택지2]
3. [선택지3]
4. [선택지4]
5. 💬 직접입력
6. 🤖 Claude판단 (충분히 파악됨)
7. ⚡ 바로 진행 | ⏹️ 중단 | ⏮️ 전단계

현재 파악: N% | 남은 요소: M개
```

### 판단 주체 (명확화)
| 항목 | 책임 |
|------|------|
| 요청의 명확/모호 판단 | **Claude** (질문으로 파악) |
| 진행 여부 결정 | **사용자** (선택지에서 결정) |
| 스킵 여부 | **사용자** (⚡선택 시 즉시 실행) |
| 수정 범위 승인 | **사용자** (계획서 보고 결정) |

### 규칙
- **Question [1] 조건부**: 불명확한 요청 시 질문으로 시작
- **⚡스킵 항상 제공**: 사용자가 단순하다 판단 시 즉시 실행
- **최대 7회**: 상한선, 사용자 스킵 시 중단 가능
- Question 2+: "이전에 [답변]이라고 하셨는데,"
- 100% 파악 또는 사용자 승인 → 계획서 → 실행

### 실행 모드 (사용자 선택)
| 🔴 필수 승인 | 🟡 확인 후 실행 | 🟢 자동 (⚡스킵 시) |
|------------|---------------|------------------|
| 파일 삭제 | 파일 수정 | 읽기 전용 |
| 시스템 설정 변경 | 외부 API 호출 | 분석/계산 |
| 대규모 리팩토링 | 새 파일 생성 | 검색/탐색 |

### 금지
- ❌ Question [1] 없이 바로 실행
- ❌ ⚡스킵 옵션 미제공
- ❌ 사용자 선택 무시하고 진행
- ❌ 맥락 추측으로 임의 실행
- ❌ 계획서 없이 대규모 수정

## Reporting (Rule 7 형식)

```
✅ 작업 완료

🔧 사용한 도구:
- [도구명] (횟수)
- 총 N회

🤖 사용한 AI:
- Cloud CLI: [목록] (N개)
- Ollama: [목록] (N개)

🔌 사용한 MCP:
- [서버명] - [용도]

👥 사용한 Agent:
- [이름] - [역할]

📊 통계:
- 병렬처리: N묶음
- 수정 파일: N개
- 소요시간: N분
```
