#!/usr/bin/env bash
# claude-validate - Validate CLAUDE.md configuration
# Version: 1.0.0

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CLAUDE_FILE="${1:-./CLAUDE.md}"
ERRORS=0
WARNINGS=0

print_header() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘     CLAUDE.md Validation Tool         â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

print_error() {
    echo -e "${RED}âŒ ERROR: $1${NC}"
    ((ERRORS++))
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  WARNING: $1${NC}"
    ((WARNINGS++))
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Validation checks
validate_file_exists() {
    if [[ ! -f "$CLAUDE_FILE" ]]; then
        print_error "CLAUDE.md not found at $CLAUDE_FILE"
        exit 1
    fi
    print_success "CLAUDE.md file found"
}

validate_required_sections() {
    local required_sections=(
        "ROLE AND EXPERTISE"
        "CORE DEVELOPMENT PRINCIPLES"
        "COMMIT DISCIPLINE"
        "CODE QUALITY STANDARDS"
    )

    for section in "${required_sections[@]}"; do
        if ! grep -qi "# $section" "$CLAUDE_FILE"; then
            print_error "Missing required section: $section"
        else
            print_success "Found section: $section"
        fi
    done
}

validate_metadata() {
    if grep -q "project:" "$CLAUDE_FILE"; then
        print_success "Project metadata found"

        # Check for project name
        if ! grep -q "name:" "$CLAUDE_FILE"; then
            print_warning "Project name not specified"
        fi

        # Check for languages
        if ! grep -q "languages:" "$CLAUDE_FILE"; then
            print_warning "Languages not specified"
        fi
    else
        print_warning "Project metadata section not found (optional but recommended)"
    fi
}

validate_methodology() {
    local methodologies=("TDD" "BDD" "DDD" "Clean Code" "Agile")
    local found=0

    for method in "${methodologies[@]}"; do
        if grep -qi "$method" "$CLAUDE_FILE"; then
            print_info "Methodology found: $method"
            ((found++))
        fi
    done

    if [[ $found -eq 0 ]]; then
        print_warning "No specific methodology mentioned"
    else
        print_success "$found methodology/methodologies defined"
    fi
}

validate_commit_convention() {
    if grep -qi "commit" "$CLAUDE_FILE"; then
        if grep -qi "conventional commit" "$CLAUDE_FILE"; then
            print_success "Commit convention: Conventional Commits"
        elif grep -qi "commit message" "$CLAUDE_FILE"; then
            print_success "Commit guidelines found"
        else
            print_warning "Commit convention mentioned but not detailed"
        fi
    else
        print_warning "No commit convention specified"
    fi
}

validate_quality_gates() {
    if grep -qi "test coverage" "$CLAUDE_FILE"; then
        print_success "Test coverage requirements found"
    else
        print_warning "No test coverage target specified"
    fi

    if grep -qi "linting\|linter" "$CLAUDE_FILE"; then
        print_success "Linting requirements found"
    fi
}

validate_examples() {
    local example_count
    example_count=$(grep -c "Example\|\`\`\`" "$CLAUDE_FILE" || echo "0")

    if [[ $example_count -gt 5 ]]; then
        print_success "Good amount of examples found ($example_count)"
    elif [[ $example_count -gt 0 ]]; then
        print_warning "Few examples found ($example_count). Consider adding more."
    else
        print_warning "No code examples found. Examples improve clarity."
    fi
}

validate_language_sections() {
    local languages=("Rust" "Python" "TypeScript" "JavaScript" "Go" "Java")
    local found=0

    for lang in "${languages[@]}"; do
        if grep -qi "## \\[$lang\\]" "$CLAUDE_FILE"; then
            print_info "Language-specific section: $lang"
            ((found++))
        fi
    done

    if [[ $found -eq 0 ]]; then
        print_info "No language-specific sections (okay for small projects)"
    fi
}

check_file_size() {
    local size_kb
    size_kb=$(du -k "$CLAUDE_FILE" | cut -f1)

    if [[ $size_kb -lt 5 ]]; then
        print_warning "CLAUDE.md is quite small (${size_kb}KB). Consider adding more details."
    elif [[ $size_kb -gt 100 ]]; then
        print_warning "CLAUDE.md is very large (${size_kb}KB). Consider splitting into multiple files."
    else
        print_success "File size looks good (${size_kb}KB)"
    fi
}

check_placeholders() {
    if grep -q "{project\." "$CLAUDE_FILE" || grep -q "{tech_stack\." "$CLAUDE_FILE"; then
        print_warning "Placeholder variables found. Did you forget to customize?"
        print_info "  Run 'claude-init' to generate a customized version"
    fi
}

# Summary
print_summary() {
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "            VALIDATION SUMMARY"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    if [[ $ERRORS -eq 0 && $WARNINGS -eq 0 ]]; then
        echo -e "${GREEN}ğŸ‰ Perfect! Your CLAUDE.md is well-configured.${NC}"
        exit 0
    elif [[ $ERRORS -eq 0 ]]; then
        echo -e "${YELLOW}âœ“ Validation passed with $WARNINGS warning(s).${NC}"
        echo -e "${YELLOW}  Consider addressing the warnings above.${NC}"
        exit 0
    else
        echo -e "${RED}âœ— Validation failed with $ERRORS error(s) and $WARNINGS warning(s).${NC}"
        echo -e "${RED}  Please fix the errors above.${NC}"
        exit 1
    fi
}

# Main
main() {
    print_header

    echo "Validating: $CLAUDE_FILE"
    echo ""

    validate_file_exists
    validate_required_sections
    validate_metadata
    validate_methodology
    validate_commit_convention
    validate_quality_gates
    validate_examples
    validate_language_sections
    check_file_size
    check_placeholders

    print_summary
}

main
